name: Start ECS GitHub Actions Runner

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行トリガー

jobs:
  start-ecs-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Start ECS Fargate Runner Task
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-1
        run: |
          echo "Launching ECS task for GitHub Actions runner..."

          GH_RUNNER_TOKEN=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.TOKEN_OF_GITHUB_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/yusukenakagawa1028/terraform-core/actions/runners/registration-token \
            | jq -r .token)

          TASK_ARN=$(aws ecs run-task \
            --cluster github-runner-cluster \
            --launch-type FARGATE \
            --task-definition github-actions-runner-task \
            --network-configuration "awsvpcConfiguration={subnets=[${{ secrets.RUNNER_EXECUTION_SUBNET_ID }}],securityGroups=[${{ secrets.RUNNER_EXECUTION_SECURITY_GROUP_ID }}],assignPublicIp=ENABLED}" \
            --overrides "$(jq -n \
              --arg token "$GH_RUNNER_TOKEN" \
              --arg pat "${{ secrets.TOKEN_OF_GITHUB_PAT }}" \
              '{
                containerOverrides: [{
                  name: "github-runner",
                  environment: [
                    { "name": "GH_RUNNER_TOKEN", "value": $token },
                    { "name": "TOKEN_OF_GITHUB_PAT", "value": $pat }
                  ]
                }]
              }')" \
            --query 'tasks[0].taskArn' --output text)

          echo "Started task: $TASK_ARN"

          while true; do
            STATUS=$(aws ecs describe-tasks --cluster github-runner-cluster --tasks $TASK_ARN \
              --query 'tasks[0].lastStatus' --output text)

            echo "Task status: $STATUS"
            if [ "$STATUS" == "STOPPED" ]; then
              break
            fi
            sleep 5
          done
  deploy:
    needs: start-ecs-runner
    runs-on: [self-hosted, ecs-runner]
    env:
      ENV_NAME: dev
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: cd environment/${ENV_NAME} && terraform init

      - name: Terraform Apply
        run: cd environment/${ENV_NAME} && terraform apply -auto-approve
